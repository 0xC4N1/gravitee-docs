[[gravitee-installation-guide-docker]]

## Docker
:docker-image-src: https://raw.githubusercontent.com/gravitee-io/gravitee-docker/master/images
:github-repo: https://github.com/gravitee-io/gravitee-docker
:docker-hub: https://hub.docker.com/r/graviteeio

Official registry: https://hub.docker.com/u/graviteeio/[] +
Source repository: https://github.com/gravitee-io/gravitee-docker/[]

IMPORTANT: We assume that you are familiar with Docker terms. +
To run our official images, you must start by installing https://docs.docker.com/installation/[Docker]

'''

### Images
We provide a complete set of images, based on the official https://hub.docker.com/_/centos/[Centos 6 image].

|===
|Image name |Source |Version |Description

|{docker-hub}/httpd/[graviteeio/httpd]
|{github-repo}/tree/master/images/base/httpd[images/base/httpd]
|latest
|Base image with Apache httpd

|{docker-hub}/java/[graviteeio/java]
|{github-repo}/tree/master/images/base/java[images/base/java]
|8u45
|Base image with Oracle Java 8u45

|{docker-hub}/kibana3/[graviteeio/kibana3]
|{github-repo}/tree/master/images/kibana3[images/kibana3]
|latest
|https://www.elastic.co/products/kibana[Kibana3] image.
Provide a complete dashboard in addition with https://www.elastic.co/products/elasticsearch[Elasticsearch]

|{docker-hub}/elasticsearch/[graviteeio/elasticsearch]
|{github-repo}/tree/master/images/elasticsearch[images/elasticsearch]
|latest
|https://www.elastic.co/products/elasticsearch[Elasticsearch] image.
Collect datas from the https://github.com/gravitee-io/gravitee-reporter-es[Elasticsearch Reporter].

|{docker-hub}/gateway/[graviteeio/gateway]
|{github-repo}/tree/master/images/gateway[images/gateway]
|latest
|https://github.com/gravitee-io/gravitee-gateway[Gateway] image.

|{docker-hub}/management-api/[graviteeio/management-api]
|{github-repo}/tree/master/images/management-api[images/management-api]
|latest
|https://github.com/gravitee-io/gravitee-management-rest-api[Management API] image.

|{docker-hub}/management-ui/[graviteeio/management-ui]
|{github-repo}/tree/master/images/management-ui[images/management-ui]
|latest
|https://github.com/gravitee-io/gravitee-management-ui[Management UI] image.

|{docker-hub}/mongodb/[graviteeio/mongodb]
|{github-repo}/tree/master/images/mongodb[images/mongodb]
|latest
|https://www.mongodb.org/[mongoDB] image.

|===


### Details

#### graviteeio/httpd

.Dockerfile
//include::{docker-image-src}/base/httpd/Dockerfile [lines=13..-1]
....
FROM centos:6
MAINTAINER Gravitee Team <http://gravitee.io>

RUN yum -y update && \
    yum install -y \
        wget \
        unzip \
        nc \
        httpd && \
    yum clean all && \
    rm -rf \
        /tmp/* \
        /var/tmp/* \
        /var/www/html/*

EXPOSE 80
VOLUME ["/var/log/httpd"]
....

A CentOS 6 with HTTPd and some tools. 
This is a base image for all apps requiring an HTTP server.

#### graviteeio/java

.Dockerfile
//include::{docker-image-src}/base/java/Dockerfile [lines=13..-1]
....
FROM centos:6
MAINTAINER Gravitee Team <http://gravitee.io>

RUN yum -y update && \
    yum install -y \
        wget \
        nc \
        unzip && \
    yum clean all && \
    rm -rf /tmp/* /var/tmp/*

RUN wget --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/8u45-b14/jre-8u45-linux-x64.rpm"
RUN rpm -Uvh jre-8u45-linux-x64.rpm && rm -f jre-8u45-linux-x64.rpm
ENV JAVA_HOME /usr/java/latest
....

A CentOS 6 with a Java Runtime 8u45 and some tools.
This is a base image for all Java apps.

#### graviteeio/kibana3

.Dockerfile
//include::{docker-image-src}/kibana3/Dockerfile [lines=13..-1]
....
FROM graviteeio/httpd:latest
MAINTAINER Gravitee Team <http://gravitee.io>

RUN wget --no-cookies https://download.elastic.co/kibana/kibana/kibana-3.1.2.zip

RUN unzip kibana-3.1.2.zip -d /tmp       && \
    mv /tmp/kibana-3.1.2/* /var/www/html && \
    rm -f kibana-3.1.2.zip               && \
    rm -rf /tmp/kibana-3.1.2

ENV ES_HOST localhost
ENV ES_PORT 9200
ENV check_links false

COPY healthcheck.sh /healthcheck.sh
RUN chmod u+x /healthcheck.sh
COPY gravitee-dashboard.json /tmp/gravitee-dashboard.json
COPY entrypoint.sh /entrypoint.sh
RUN chmod u+x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

CMD ["/usr/sbin/httpd", "-DFOREGROUND"]
....

Kibana3 image provide a complete dashboard over gravitee usage.
Because Kibana3 need Elacticsearch at runtime, you have 2 environment variables to modify (via `docker run --env`) :

* ES_HOST
* ES_PORT

Because this image is used in our demo, another variable is provided : `check_links`.
If you set it to true, the container will wait until elasticsearch is reachable inside the container.
And only after that, the httpd server will start.

On startup, the container will post his dashboard into elasticsearh.

#### graviteeio/elasticsearch

.Dockerfile
//include::{docker-image-src}/elasticsearch/Dockerfile [lines=13..-1]
....
FROM graviteeio/java:8u45
MAINTAINER Gravitee Team <http://gravitee.io>

COPY elasticsearch.repo /etc/yum.repos.d/elasticsearch.repo
RUN rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch
RUN yum install -y elasticsearch initscripts.x86_64 && \
    yum clean all && \
    rm -rf /tmp/* /var/tmp/*

RUN echo 'http.cors.enabled: true' >> /etc/elasticsearch/elasticsearch.yml
RUN echo 'http.cors.allow-origin: "*"' >> /etc/elasticsearch/elasticsearch.yml

RUN /usr/share/elasticsearch/bin/plugin --install lmenezes/elasticsearch-kopf
RUN /usr/share/elasticsearch/bin/plugin --install royrusso/elasticsearch-HQ
RUN /usr/share/elasticsearch/bin/plugin --install lukas-vlcek/bigdesk
RUN /usr/share/elasticsearch/bin/plugin --install mobz/elasticsearch-head

EXPOSE 9200 9300
VOLUME ["/var/log/elasticsearch", "/var/lib/elasticsearch"]

CMD ["/usr/share/elasticsearch/bin/elasticsearch", \
    "-Des.default.path.home=/usr/share/elasticsearch", \
    "-Des.default.path.logs=/var/log/elasticsearch", \
    "-Des.default.path.data=/var/lib/elasticsearch", \
    "-Des.default.path.work=/tmp/elasticsearch", \
    "-Des.default.path.conf=/etc/elasticsearch"]
....

Elasticsearch image works with our https://github.com/gravitee-io/gravitee-reporter-es[Elasticsearch Reporter] and render his datas via our Kibana3 image.

#### graviteeio/gateway

.Dockerfile
//include::{docker-image-src}/gateway/Dockerfile [lines=13..-1]
....
FROM graviteeio/java:8u45
MAINTAINER Gravitee Team <http://gravitee.io>

RUN echo 'root:gravitee' |chpasswd
RUN groupadd gravitee && useradd -s /bin/bash -m -g gravitee gravitee
RUN echo 'gravitee:gravitee' |chpasswd

# Download gravitee
WORKDIR /home/gravitee
RUN wget http://build.gravitee.io/jenkins/job/gravitee-standalone/lastSuccessfulBuild/artifact/gravitee-standalone-distribution/zip/target/gravitee-standalone-1.0.0-SNAPSHOT.zip && \
    unzip gravitee-standalone-1.0.0-SNAPSHOT.zip && \
    rm gravitee-standalone-1.0.0-SNAPSHOT.zip
RUN mkdir -p /etc/gravitee.io/log/
RUN chown -R gravitee:gravitee /etc/gravitee.io/

# Download plugins
WORKDIR /home/gravitee/plugins
RUN wget http://build.gravitee.io/jenkins/job/gravitee-reporter-es/lastSuccessfulBuild/artifact/target/gravitee-reporter-es-1.0.0-SNAPSHOT.zip

# Add apis
WORKDIR /home/gravitee
RUN mkdir -p apis
COPY weather.json apis/weather.json
COPY local_default_gravitee.yml config/local_default_gravitee.yml

ENV MONGO_DEFAULT_HOST localhost
ENV MONGO_DEFAULT_PORT 27017
ENV MONGO_HOST localhost
ENV MONGO_PORT 27017
ENV ES_DEFAULT_HOST localhost
ENV ES_HOST localhost
ENV load_samples false
ENV check_links false

COPY healthcheck.sh /healthcheck.sh
RUN chmod u+x /healthcheck.sh

COPY entrypoint.sh /entrypoint.sh
RUN chmod u+x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

EXPOSE 8082
VOLUME ["/etc/gravitee.io/log"]

CMD ["/home/gravitee/bin/gravitee"]
....

The gateway image provides a set of environment variables which could be used to tune your container. Because mongoDB is our default repository, you could replace default mongoDB address (`MONGO_DEFAULT_HOST:MONGO_DEFAULT_PORT`) by the one you provide (`MONGO_HOST:MONGO_PORT`).
The gateway image also use the elasticsearch reporter. You could replace default ES address (`ES_DEFAULT_HOST`) by the one you provide (`ES_HOST`).

Because this image is used in our demo, another variable is provided : `check_links`.
If you set it to true, the container will wait until mongoDB and elasticsearch is reachable inside the container.
And only after that, the gateway will start.

If you set `load_samples` to true, you inject samples api in the gateway. This is used in our demo.

### graviteeio/management-api

.Dockerfile
//include::{docker-image-src}/management-api/Dockerfile [lines=13..-1]
....
FROM graviteeio/java:8u45
MAINTAINER Gravitee Team <http://gravitee.io>

RUN echo 'root:gravitee' |chpasswd
RUN groupadd gravitee && useradd -s /bin/bash -m -g gravitee gravitee
RUN echo 'gravitee:gravitee' |chpasswd

WORKDIR /home/gravitee
RUN wget http://build.gravitee.io/jenkins/job/gravitee-management-rest-api/lastSuccessfulBuild/artifact/standalone/distribution/zip/target/gravitee-management-standalone-1.0.0-SNAPSHOT.zip && \
	unzip gravitee-management-standalone-1.0.0-SNAPSHOT.zip && \
    rm gravitee-management-standalone-1.0.0-SNAPSHOT.zip

ENV MONGO_DEFAULT_HOST localhost
ENV MONGO_DEFAULT_PORT 27017
ENV MONGO_HOST localhost
ENV MONGO_PORT 27017
ENV check_links false

COPY healthcheck.sh /healthcheck.sh
RUN chmod u+x /healthcheck.sh

COPY entrypoint.sh /entrypoint.sh
RUN chmod u+x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

EXPOSE 8082
VOLUME ["/home/gravitee/log"]

CMD ["/home/gravitee/bin/gravitee"]
....

The management-api image provides a set of environment variables which could be used to tune your container. Because mongoDB is our default repository, you could replace default mongoDB address (`MONGO_DEFAULT_HOST:MONGO_DEFAULT_PORT`) by the one you provide (`MONGO_HOST:MONGO_PORT`).

Because this image is used in our demo, another variable is provided : `check_links`.
If you set it to true, the container will wait until mongoDB is reachable inside the container.
And only after that, the management-api will start.


### graviteeio/management-ui

.Dockerfile
//include::{docker-image-src}/management-ui/Dockerfile [lines=13..-1]
....
FROM graviteeio/httpd:latest
MAINTAINER Gravitee Team <http://gravitee.io>

RUN wget --no-cookies  http://build.gravitee.io/jenkins/job/gravitee-management-webui/lastSuccessfulBuild/artifact/target/gravitee-management-webui-1.0.0-SNAPSHOT-bin.zip && \
    unzip gravitee-management-webui-1.0.0-SNAPSHOT-bin.zip -d /tmp       && \
    mv /tmp/gravitee-management-webui-1.0.0-SNAPSHOT/* /var/www/html    && \
    rm -f gravitee-management-webui-1.0.0-SNAPSHOT-bin.zip               && \
    rm -rf /tmp/gravitee-management-webui-1.0.0-SNAPSHOT

ENV MGMT_API_DEFAULT_HOST localhost 
ENV MGMT_API_DEFAULT_PORT 8082
ENV MGMT_API_HOST localhost
ENV MGMT_API_PORT 8082

COPY entrypoint.sh /entrypoint.sh
RUN chmod u+x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

CMD ["/usr/sbin/httpd", "-DFOREGROUND"]
....

The management-ui image provides a set of environment variables which could be used to tune your container. The UI need to know where the management-api is. So you have to override `MGMT_API_HOST` and `MGMT_API_PORT` to specify where the management-api is running.

### graviteeio/mongodb

.Dockerfile
//include::{docker-image-src}/mongodb/Dockerfile [lines=13..-1]
....
FROM centos:6
MAINTAINER Gravitee Team <http://gravitee.io>

COPY mongodb-org-3.0.repo /etc/yum.repos.d/mongodb-org-3.0.repo

RUN yum -y update && \
    yum install -y mongodb-org && \
    yum clean all && \
    rm -rf /tmp/* /var/tmp/*

EXPOSE 27017
VOLUME ["/var/log/mongodb", "/var/lib/mongo"]

CMD ["/usr/bin/mongod", "--dbpath", "/var/lib/mongo", "--bind_ip", "0.0.0.0", "--port", "27017", "--logpath", "/var/log/mongodb/mongod.log", "--logappend"]
....

mongoDB is the default https://github.com/gravitee-io/gravitee-repository-mongodb[repository] we used in gravitee.
